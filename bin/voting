#!/usr/bin/env ruby

require 'vote-schulze'

def benchmarks(benchmark_file, ignore_file)
  require 'yaml'
  bench  = YAML.load File.read benchmark_file
  ignore = YAML.load File.read ignore_file

  bench.reject{|(k, _)| ignore.include? k}
end

benchmark_file, ignore_file, var, reverse = ARGV

data = benchmarks(benchmark_file, ignore_file)

candidates = data.map do |_, v|
  v.map{|i| [i[:image], i[:proc]]}
end.flatten(1).uniq

votes = data.map do |_, values|
  candidate_order = values.sort_by{|i| i[var.to_sym]}.map{|i| [i[:image], i[:proc]]}
  candidate_order.reverse! if not reverse
  candidates.map{|c| candidate_order.find_index(c) || 0}.compact
end

vs = SchulzeBasic.do votes, candidates.length
score = vs.ranks_abc.map do |i|
  letter = i.split(':').first
  index  = ('A'..'Z').find_index(letter)
  candidates[index]
end

puts YAML.dump(score)
