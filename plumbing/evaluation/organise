#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', '..', 'lib'))

require 'set'
require 'yaml'
require 'evaluation'
require 'evaluation/aggregate'
require 'evaluation/reformat'

mapping, evaluations = ARGV.map{|i| YAML.load(File.read(i)) }

keys = [[:benchmark,  :type],
        [:input_data, :data_id],
        [:input_data, :entry_id],
        [:image,      :dockerhub],
        [:image,      :task]]

output = Evaluation.group(evaluations, keys) do |replicates|
  summary =  Evaluation::Aggregate.aggregate(replicates)
  if summary[:status] == :complete
    summary[:metrics] = Evaluation::Reformat.rename(summary[:metrics], mapping)
  end
  {summary:    summary,
   replicates: replicates}
end

puts YAML.dump(output)
