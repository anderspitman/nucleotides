#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', '..', 'lib'))

require 'set'
require 'yaml'
require 'evaluation/aggregate'
require 'evaluation/reformat'

def group(data, keys, &block)
  if keys.empty?
    block.call data
  else
    head, *tail = keys
    grouped = data.group_by do |datum|
      head.inject(datum){|h, k| h[k] }
    end
    grouped.map do |k, v|
      {id: head.join('_'), key: k, values: group(v, tail, &block)}
    end
  end
end

mapping, evaluations = ARGV.map{|i| YAML.load(File.read(i)) }

keys = [[:benchmark,  :type],
        [:input_data, :data_id],
        [:input_data, :entry_id],
        [:image,      :dockerhub],
        [:image,      :task]]

output = group(evaluations, keys) do |replicates|
  summary =  Evaluation::Aggregate.aggregate(replicates)
  if summary[:status] == :complete
    summary[:metrics] = Evaluation::Reformat.rename(summary[:metrics], mapping)
  end
  {summary:    summary,
   replicates: replicates}
end

puts YAML.dump(output)
